<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Polish Master Trainer: Game Edition</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PL Trainer">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/197/197529.png">

    <style>
        :root { --primary: #1a73e8; --secondary: #34a853; --accent: #673ab7; --bg: #f0f2f5; --card-bg: #ffffff; --text: #202124; --border: #e0e0e0; --xp-bar: #34a853; --error: #d93025; }
        .dark-mode { --bg: #121212; --card-bg: #1e1e1e; --text: #e8eaed; --border: #3c4043; --xp-bar: #42f57e; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; background-color: var(--bg); color: var(--text); margin: 0; padding: 10px; height: 100vh; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        
        /* Game Stats */
        .stats-container { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 420px; background: var(--card-bg); padding: 12px; border-radius: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid var(--border); }
        .stat-item { display: flex; flex-direction: column; align-items: center; font-weight: bold; font-size: 0.75rem; }
        .stat-value { font-size: 1.1rem; color: var(--primary); }
        .xp-progress-bg { flex-grow: 1; height: 12px; background: #eee; border-radius: 6px; margin: 0 15px; overflow: hidden; position: relative; border: 1px solid var(--border); }
        .xp-progress-fill { height: 100%; background: var(--xp-bar); width: 0%; transition: width 0.4s ease-out; }

        .header-section { text-align: center; margin-bottom: 5px; width: 100%; max-width: 420px; }
        .main-title { font-size: 1.0rem; font-weight: bold; text-transform: uppercase; margin: 0; }
        .header-controls { display: flex; justify-content: center; gap: 10px; margin-top: 5px; }
        .ui-btn { background: var(--card-bg); border: 1px solid var(--border); padding: 4px 10px; border-radius: 8px; font-weight: bold; font-size: 0.7rem; cursor: pointer; color: var(--text); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .top-bar { display: flex; justify-content: center; width: 100%; max-width: 420px; margin-bottom: 10px; }
        nav { display: flex; gap: 2px; background: var(--card-bg); padding: 4px; border-radius: 50px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow-x: auto; scrollbar-width: none; }
        nav button { background: none; border: none; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-weight: bold; color: #5f6368; font-size: 0.7rem; white-space: nowrap; }
        nav button.active { background: var(--primary); color: white; }

        .card { background: var(--card-bg); padding: 1rem; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 420px; display: flex; flex-direction: column; position: relative;}
        
        /* Mode Toggle */
        .mode-toggle { display: flex; background: rgba(0,0,0,0.05); padding: 3px; border-radius: 8px; margin-bottom: 10px; }
        .mode-toggle button { flex: 1; border: none; background: none; font-size: 0.65rem; font-weight: bold; padding: 6px; cursor: pointer; border-radius: 6px; color: var(--text); }
        .mode-toggle button.active { background: var(--card-bg); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .controls-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; width: 100%; }
        .control-box { flex: 1; padding: 8px; background: rgba(0,0,0,0.03); border-radius: 10px; border: 1px solid var(--border); text-align: left; min-width: 120px;}
        .label-text { font-weight: bold; font-size: 0.7rem; display: block; margin-bottom: 2px; opacity: 0.8; }
        input[type=range] { width: 100%; height: 20px; cursor: pointer; }
        
        /* Multiple Choice Grid */
        .game-input-area { margin: 10px 0; min-height: 80px; }
        .mc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .mc-btn { background: var(--card-bg); border: 2px solid var(--border); padding: 15px 5px; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; color: var(--text); box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; min-height: 50px; }
        .mc-btn:active { transform: scale(0.98); }
        .mc-btn.correct { background: var(--secondary); color: white; border-color: var(--secondary); }
        .mc-btn.wrong { background: var(--error); color: white; border-color: var(--error); opacity: 0.6; }
        
        /* Key Input */
        .text-input-field { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid var(--border); background: var(--bg); color: var(--text); font-size: 1.1rem; text-align: center; outline: none; }
        .text-input-field:focus { border-color: var(--primary); }
        .text-input-field.correct { border-color: var(--secondary); background: rgba(52, 168, 83, 0.1); }
        .text-input-field.wrong { border-color: var(--error); background: rgba(217, 48, 37, 0.1); }

        .display-area { margin: 5px 0; display: flex; flex-direction: column; justify-content: center; }
        .polish-text { font-size: 0.9rem; color: var(--primary); font-weight: bold; visibility: hidden; line-height: 1.2; min-height: 1.2em;}
        .english-text { font-size: 0.75rem; color: #888; visibility: hidden; margin-top: 4px; min-height: 1.2em;}
        
        .button-grid { display: flex; flex-direction: column; gap: 6px; margin-top: 5px; }
        button.action { padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.75rem; font-weight: 600; color: white; }
        .audio-group { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; border: 2px solid #fb8c00; padding: 6px; border-radius: 12px; }
        .btn-next { background-color: #455a64; margin-top: 5px; }
        .btn-listen { background-color: var(--secondary); grid-column: span 2; }
        .btn-slow { background-color: #fb8c00; }
        .btn-v-slow { background-color: #e65100; }
        .reveal-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .btn-reveal-pl { background-color: var(--primary); }
        .btn-reveal-en { background-color: var(--accent); }

        /* Toggles */
        .toggle-row { display: flex; flex-direction: column; background: rgba(0,0,0,0.03); border-radius: 10px; padding: 8px; border: 1px solid var(--border); margin-bottom: 8px; gap: 8px; }
        .toggle-item { display: flex; align-items: center; gap: 3px; font-size: 0.65rem; font-weight: bold; }
        .unit-group { display: flex; justify-content: space-around; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 5px; }

        #modalOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:1000; padding:20px; }
        .modal-content { background:var(--card-bg); color:var(--text); padding:25px; border-radius:15px; max-width:400px; width:100%; box-shadow:0 10px 25px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div class="stats-container">
    <div class="stat-item">
        <span id="lbl-lvl">LVL</span>
        <span id="game-level" class="stat-value">1</span>
    </div>
    <div class="xp-progress-bg">
        <div id="game-xp-bar" class="xp-progress-fill"></div>
    </div>
    <div class="stat-item">
        <span id="lbl-streak">STREAK</span>
        <span id="game-streak" class="stat-value">0</span>
    </div>
</div>

<div class="header-section">
    <div class="main-title" id="lbl-title">Polish Master Trainer</div>
    <div class="header-controls">
        <button class="ui-btn" onclick="toggleUILanguage()" id="uiLangBtn">EN / PL</button>
        <button class="ui-btn" onclick="toggleDarkMode()" id="lbl-dark">Dark Mode</button>
        <button class="ui-btn" onclick="showHelp()" id="lbl-help">Help</button>
    </div>
</div>

<div class="top-bar">
    <nav>
        <button id="nav-numbers" onclick="setMode('numbers')">Numbers</button>
        <button id="nav-prices" onclick="setMode('prices')">Prices</button>
        <button id="nav-dates" onclick="setMode('dates')">Dates</button>
        <button id="nav-time" onclick="setMode('time')">Time</button>
        <button id="nav-weights" onclick="setMode('weights')">Weights</button>
    </nav>
</div>

<div class="card">
    <div class="mode-toggle">
        <button id="mode-mc" class="active" onclick="setInputMode('mc')">Multiple Choice</button>
        <button id="mode-key" onclick="setInputMode('key')">Key Input</button>
    </div>

    <div id="sliderContainer" class="controls-row">
        <div class="control-box">
            <span class="label-text"><span id="lbl-min">Min</span>: <span id="minValLabel">1</span></span>
            <input type="range" id="minPower" min="0" max="6" value="0" oninput="handleMinChange()">
        </div>
        <div class="control-box">
            <span class="label-text"><span id="lbl-max">Max</span>: <span id="maxValLabel">10</span></span>
            <input type="range" id="maxPower" min="1" max="7" value="1" oninput="updateSliders()">
        </div>
        <div class="control-box" style="display: flex; align-items: center; justify-content: center;">
            <label class="toggle-item" style="font-size: 0.75rem;">
                <input type="checkbox" id="allowNegatives" onchange="generateNext()"> 
                <span id="lbl-neg">Negative #</span>
            </label>
        </div>
    </div>

    <div id="priceControls" style="display:none;">
        <div class="toggle-row" style="flex-direction: row; justify-content: center;">
            <label class="toggle-item"><input type="checkbox" id="includeGroszy" checked onchange="generateNext()"> <span id="lbl-incGrosz">Grosze</span></label>
        </div>
    </div>
    <div id="dateControls" style="display:none;">
        <div class="toggle-row" style="flex-direction: row; justify-content: space-around;">
            <label class="toggle-item"><input type="checkbox" id="includeDayOfWeek" checked onchange="generateNext()"> <span id="lbl-incDay">Day</span></label>
            <label class="toggle-item"><input type="checkbox" id="includeYear" checked onchange="generateNext()"> <span id="lbl-incYear">Year</span></label>
        </div>
    </div>
    <div id="timeControls" style="display:none;">
        <div class="toggle-row" style="flex-direction: row; justify-content: space-around;">
            <label class="toggle-item"><input type="radio" name="timeStyle" id="styleFormal" onchange="generateNext()"> <span id="lbl-incFormal">Formal</span></label>
            <label class="toggle-item"><input type="radio" name="timeStyle" id="styleCasual" checked onchange="generateNext()"> <span id="lbl-incCasual">Casual</span></label>
        </div>
    </div>
    <div id="weightControls" style="display:none;">
        <div class="toggle-row">
            <div class="unit-group">
                <span class="unit-tag">Weight</span>
                <label class="toggle-item"><input type="radio" name="weightUnit" value="t" onchange="generateNext()"> <span>t</span></label>
                <label class="toggle-item"><input type="radio" name="weightUnit" value="kg" checked onchange="generateNext()"> <span>kg</span></label>
                <label class="toggle-item"><input type="radio" name="weightUnit" value="dkg" onchange="generateNext()"> <span>dkg</span></label>
                <label class="toggle-item"><input type="radio" name="weightUnit" value="g" onchange="generateNext()"> <span>g</span></label>
            </div>
            <div class="unit-group">
                <span class="unit-tag">Volume</span>
                <label class="toggle-item"><input type="radio" name="weightUnit" value="ml" onchange="generateNext()"> <span>ml</span></label>
                <label class="toggle-item"><input type="radio" name="weightUnit" value="l" onchange="generateNext()"> <span>l</span></label>
                <label class="toggle-item"><input type="radio" name="weightUnit" value="szk" onchange="generateNext()"> <span>szk.</span></label>
                <label class="toggle-item" style="border-left: 1px solid #ccc; padding-left: 5px;">
                    <input type="checkbox" id="includeFractions" onchange="generateNext()"> <span id="lbl-incFrac">Frac.</span>
                </label>
            </div>
        </div>
    </div>

    <div class="game-input-area">
        <div id="mc-container" class="mc-grid"></div>
        <div id="key-container" style="display:none;">
            <input type="text" id="answer-input" class="text-input-field" placeholder="Type what you hear..." autocomplete="off" onkeydown="handleKeyEntry(event)">
        </div>
    </div>

    <div class="display-area">
        <div id="polishText" class="polish-text">---</div>
        <div id="englishText" class="english-text">---</div>
    </div>

    <div class="button-grid">
        <div class="audio-group">
            <button class="action btn-listen" onclick="speak(1.0)"><span id="btn-listen"> Repeat</span></button>
            <button class="action btn-slow" onclick="speak(0.4)"><span id="btn-slow"> Slowly (0.4)</span></button>
            <button class="action btn-v-slow" onclick="speak(0.2)"><span id="btn-vslow"> Snail (0.2)</span></button>
        </div>
        <div class="reveal-row">
            <button class="action btn-reveal-pl" onclick="reveal('polishText')"><span id="btn-revPl">Reveal Polish</span></button>
            <button class="action btn-reveal-en" onclick="reveal('englishText')"><span id="btn-revEn">Reveal English</span></button>
        </div>
        <button id="btn-next-action" class="action btn-next" onclick="generateNext()"><span id="btn-next">Skip / Next ★</span></button>
    </div>
</div>

<div id="modalOverlay">
    <div class="modal-content">
        <h3 style="margin-top:0; color:var(--primary);">How to Play</h3>
        <ul style="padding-left:20px; font-size:0.85rem; line-height:1.6;">
            <li>Select <b>Multiple Choice</b> or <b>Key Input</b>.</li>
            <li>Listen to the Polish phrase.</li>
            <li>Select or type the meaning (in English/Digits).</li>
            <li>Use the <b>Negative #</b> toggle for extra challenge!</li>
        </ul>
        <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center; border-top:1px solid var(--border); padding-top:10px;">
            <label style="font-size:0.75rem;"><input type="checkbox" id="dontShow"> Don't show again</label>
            <button class="ui-btn" style="background:var(--primary); color:white; border:none;" onclick="closeHelp()">Play!</button>
        </div>
    </div>
</div>

<script>
    let currentMode = 'numbers', uiLang = 'en', currentPolish = "", currentEnglish = "";
    let inputMode = 'mc'; 
    let gameState = {
        xp: parseInt(localStorage.getItem('pl_xp_v3')) || 0,
        level: parseInt(localStorage.getItem('pl_lvl_v3')) || 1,
        streak: 0,
        answered: false,
        peaked: false
    };

    // Translations
    const translations = {
        en: { title: "Polish Master Trainer", numbers: "Numbers", prices: "Prices", dates: "Dates", time: "Time", weights: "Weights", min: "Min", max: "Max", incYear: "Year", incDay: "Day", incGrosz: "Grosze", incFrac: "Frac.", incFormal: "Formal", incCasual: "Casual", listen: " Repeat", slow: " Slowly (0.4)", vslow: " Snail (0.2)", revPl: "Reveal Polish", revEn: "Reveal English", next: "Skip / Next ★", helpH: "How to Play", dark: "Dark Mode", help: "Help", lvl: "LEVEL", streak: "STREAK", neg: "Negatives" },
        pl: { title: "Mistrz Polskich Liczb", numbers: "Liczby", prices: "Ceny", dates: "Daty", time: "Czas", weights: "Waga", min: "Min", max: "Max", incYear: "Rok", incDay: "Dzie", incGrosz: "Grosze", incFrac: "U.", incFormal: "Oficjalny", incCasual: "Potoczny", listen: " Powt贸rz", slow: "Wolno (0.4)", vslow: "B.Wolno (0.2)", revPl: "Poka偶 PL", revEn: "Poka偶 EN", next: "Pomi ★", helpH: "Jak gra", dark: "Tryb nocny", help: "Pomoc", lvl: "POZIOM", streak: "SERIA", neg: "Ujemne" }
    };

    // Data Arrays
    const units = ["", "jeden", "dwa", "trzy", "cztery", "pi", "sze", "siedem", "osiem", "dziewi"];
    const teens = ["dziesi", "jedenacie", "dwanacie", "trzynacie", "czternacie", "pitnacie", "szesnacie", "siedemnacie", "osiemnacie", "dziewitnacie"];
    const tens = ["", "", "dwadziecia", "trzydzieci", "czterdzieci", "pidziesit", "szedziesit", "siedemdziesit", "osiemdziesit", "dziewidziesit"];
    const hundreds = ["", "sto", "dwiecie", "trzysta", "czterysta", "piset", "szeset", "siedemset", "osiemset", "dziewitset"];
    const ordinals = ["", "pierwszy", "drugi", "trzeci", "czwarty", "pity", "sz贸sty", "si贸dmy", "贸smy", "dziewity", "dziesity", "jedenasty", "dwunasty", "trzynasty", "czternasty", "pitnasty", "szesnasty", "siedemnasty", "osiemnasty", "dziewitnasty", "dwudziesty", "dwudziesty pierwszy", "dwudziesty drugi", "dwudziesty trzeci", "dwudziesty czwarty", "dwudziesty pity", "dwudziesty sz贸sty", "dwudziesty si贸dmy", "dwudziesty 贸smy", "dwudziesty dziewity", "trzydziesty", "trzydziesty pierwszy"];
    const monthsGenitive = ["stycznia", "lutego", "marca", "kwietnia", "maja", "czerwca", "lipca", "sierpnia", "wrzenia", "pa藕dziernika", "listopada", "grudnia"];
    const monthsEn = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const weekDaysPl = ["Poniedziaek", "Wtorek", "roda", "Czwartek", "Pitek", "Sobota", "Niedziela"];
    const weekDaysEn = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

    function getPluralForm(n, singular, pluralA, pluralB) {
        n = Math.abs(n);
        if (n === 1) return singular;
        const lastDigit = n % 10, lastTwo = n % 100;
        if (lastDigit >= 2 && lastDigit <= 4 && (lastTwo < 10 || lastTwo > 20)) return pluralA;
        return pluralB;
    }

    function numberToPolish(n) {
        if (n === 0) return "zero";
        if (n < 0) return "minus " + numberToPolish(Math.abs(n));
        
        let res = "";
        let mil = Math.floor(n / 1000000);
        if (mil > 0) res += (mil === 1 ? "" : numberToPolish(mil) + " ") + getPluralForm(mil, "milion", "miliony", "milion贸w") + " ";
        let thou = Math.floor((n % 1000000) / 1000);
        if (thou > 0) res += (thou === 1 ? "tysic" : numberToPolish(thou) + " " + getPluralForm(thou, "tysic", "tysice", "tysicy")) + " ";
        let rem = n % 1000, h = Math.floor(rem / 100), t = Math.floor((rem % 100) / 10), u = rem % 10;
        if (h > 0) res += hundreds[h] + " ";
        if (t === 1) res += teens[u];
        else { if (t > 1) res += tens[t] + " "; if (u > 0) res += units[u]; }
        return res.trim();
    }

    function timeToPolish(hh, mm, formal) {
        const hoursOrdFem = ["p贸noc", "pierwsza", "druga", "trzecia", "czwarta", "pita", "sz贸sta", "si贸dma", "贸sma", "dziewita", "dziesita", "jedenasta", "dwunasta", "trzynasta", "czternasta", "pitnasta", "szesnasta", "siedemnasta", "osiemnasta", "dziewitnasta", "dwudziesta", "dwudziesta pierwsza", "dwudziesta druga", "dwudziesta trzecia"];
        const hoursOrdGen = ["p贸nocy", "pierwszej", "drugiej", "trzeciej", "czwartej", "pitej", "sz贸stej", "si贸dmej", "贸smej", "dziewitej", "dziesitej", "jedenastej", "dwunastej", "pierwszej"];
        if (formal) {
            let hStr = (hh === 0) ? "zero zero" : hoursOrdFem[hh];
            let mStr = (mm === 0) ? "" : (mm < 10 ? "zero " + units[mm] : numberToPolish(mm));
            return `${hStr} ${mStr}`.trim();
        } else {
            let displayH = hh % 12;
            const hNow = hoursOrdFem[displayH === 0 ? 12 : displayH];
            const hNext = hoursOrdGen[(displayH === 0 ? 0 : displayH) + 1];
            if (mm === 0) return hNow;
            if (mm === 30) return `wp贸 do ${hNext}`;
            if (mm < 30) return `${numberToPolish(mm)} po ${hoursOrdGen[displayH === 0 ? 12 : displayH]}`;
            return `za ${numberToPolish(60 - mm)} ${hNext}`;
        }
    }

    // --- Core Game Functions ---

    function setInputMode(mode) {
        inputMode = mode;
        document.getElementById('mode-mc').classList.toggle('active', mode === 'mc');
        document.getElementById('mode-key').classList.toggle('active', mode === 'key');
        document.getElementById('mc-container').style.display = (mode === 'mc') ? 'grid' : 'none';
        document.getElementById('key-container').style.display = (mode === 'key') ? 'block' : 'none';
        if(currentPolish === "") generateNext();
    }

    function updateGameUI() {
        const xpToLevel = gameState.level * 100;
        if (gameState.xp >= xpToLevel) { gameState.xp -= xpToLevel; gameState.level++; }
        localStorage.setItem('pl_xp_v3', gameState.xp);
        localStorage.setItem('pl_lvl_v3', gameState.level);
        
        document.getElementById('game-xp-bar').style.width = ((gameState.xp / xpToLevel) * 100) + '%';
        document.getElementById('game-level').innerText = gameState.level;
        document.getElementById('game-streak').innerText = gameState.streak;
    }

    function generateNext() {
        gameState.answered = false;
        gameState.peaked = false;
        document.getElementById('answer-input').value = "";
        document.getElementById('answer-input').className = "text-input-field";
        
        const min = Math.pow(10, document.getElementById('minPower').value);
        const max = Math.pow(10, document.getElementById('maxPower').value);
        const allowNeg = document.getElementById('allowNegatives').checked;

        // Fully Restored Logic for All Modes
        if (currentMode === 'dates') {
            const dayIdx = Math.floor(Math.random() * 7), dayNum = Math.floor(Math.random() * 31) + 1, monthIdx = Math.floor(Math.random() * 12);
            let enStr = `${dayNum} ${monthsEn[monthIdx]}`, plStr = `${ordinals[dayNum]} ${monthsGenitive[monthIdx]}`;
            if (document.getElementById('includeDayOfWeek').checked) { enStr = weekDaysEn[dayIdx] + ", " + enStr; plStr = weekDaysPl[dayIdx] + ", " + plStr; }
            if (document.getElementById('includeYear').checked) { const year = Math.floor(Math.random() * 125) + 1900; enStr += " " + year; plStr += " " + numberToPolish(year) + " roku"; }
            currentEnglish = enStr; currentPolish = plStr;
        } 
        else if (currentMode === 'time') {
            const hh = Math.floor(Math.random() * 24), mm = [0, 5, 10, 20, 25, 30, 35, 40, 50, 55][Math.floor(Math.random() * 10)];
            currentEnglish = `${hh.toString().padStart(2, '0')}:${mm.toString().padStart(2, '0')}`;
            currentPolish = timeToPolish(hh, mm, document.getElementById('styleFormal').checked);
        } 
        else if (currentMode === 'weights') {
            let unit = document.querySelector('input[name="weightUnit"]:checked').value;
            let unitNames = { t: ["tona","tony","ton","tony"], kg: ["kilogram","kilogramy","kilogram贸w","kilograma"], dkg: ["dekagram","dekagramy","dekagram贸w","dekagrama"], g: ["gram","gramy","gram贸w","grama"], ml: ["mililitr","mililitry","mililitr贸w","mililitra"], l: ["litr","litry","litr贸w","litra"], szk: ["szklanka","szklanki","szklanek","szklanki"] };
            if (document.getElementById('includeFractions').checked && Math.random() < 0.5) {
                let fracType = Math.floor(Math.random() * 4);
                if (fracType === 0) { currentEnglish = `1/2 ${unit}`; currentPolish = `p贸 ${unitNames[unit][3]}`; }
                else if (fracType === 1) { currentEnglish = `1 1/2 ${unit}`; currentPolish = `p贸tora ${unitNames[unit][3]}`; }
                else if (fracType === 2) { let n = Math.floor(Math.random() * 8) + 2; currentEnglish = `${n} 1/2 ${unit}`; currentPolish = `${numberToPolish(n)} i p贸 ${unitNames[unit][3]}`; }
                else { let n = Math.floor(Math.random() * 8) + 2; currentEnglish = `${n} 1/4 ${unit}`; currentPolish = `${numberToPolish(n)} i wier ${unitNames[unit][3]}`; }
            } else {
                let num = Math.floor(Math.random() * (max - min + 1)) + min;
                currentEnglish = `${num.toLocaleString()} ${unit}`; currentPolish = `${numberToPolish(num)} ${getPluralForm(num, unitNames[unit][0], unitNames[unit][1], unitNames[unit][2])}`;
            }
        } 
        else {
            // Numbers & Prices
            let num = Math.floor(Math.random() * (max - min + 1)) + min;
            // Negative logic only for Numbers mode
            if (currentMode === 'numbers' && allowNeg && Math.random() > 0.5) num = num * -1;

            if (currentMode === 'numbers') { 
                currentEnglish = num.toLocaleString(); 
                currentPolish = numberToPolish(num); 
            }
            else { // Prices
                let zlWord = getPluralForm(num, "zoty", "zote", "zotych");
                if (document.getElementById('includeGroszy').checked) {
                    let gr = Math.floor(Math.random() * 99) + 1;
                    currentEnglish = `${num.toLocaleString()},${gr.toString().padStart(2, '0')} z`;
                    currentPolish = `${numberToPolish(num)} ${zlWord} i ${numberToPolish(gr)} ${getPluralForm(gr, "grosz", "grosze", "groszy")}`;
                } else { 
                    currentEnglish = num.toLocaleString() + " z"; 
                    currentPolish = numberToPolish(num) + " " + zlWord; 
                }
            }
        }

        document.getElementById('polishText').style.visibility = 'hidden';
        document.getElementById('englishText').style.visibility = 'hidden';
        document.getElementById('polishText').innerText = currentPolish;
        document.getElementById('englishText').innerText = currentEnglish;

        if (inputMode === 'mc') setupMC();
        setTimeout(() => speak(1.0), 100);
    }

    function setupMC() {
        const container = document.getElementById('mc-container');
        container.innerHTML = "";
        
        let options = [{val: currentEnglish, correct: true}];
        
        // Generate valid decoys based on currentEnglish format
        while(options.length < 4) {
            let decoy = generateDecoy(currentEnglish);
            if (!options.some(o => o.val === decoy)) options.push({val: decoy, correct: false});
        }
        options.sort(() => Math.random() - 0.5);
        
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = "mc-btn";
            btn.innerText = opt.val;
            btn.onclick = () => checkAnswer(opt.correct, btn);
            container.appendChild(btn);
        });
    }

    // Helper to generate context-aware decoys
    function generateDecoy(original) {
        if (currentMode === 'time') {
            let h = Math.floor(Math.random() * 24);
            let m = Math.floor(Math.random() * 60);
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
        }
        if (currentMode === 'dates') {
            // Simple decoy: just random day/month
            let mIdx = Math.floor(Math.random() * 12);
            let d = Math.floor(Math.random() * 28) + 1;
            return `${d} ${monthsEn[mIdx]}` + (original.match(/\d{4}/) ? " " + (1900 + Math.floor(Math.random()*125)) : "");
        }
        // Numbers/Prices/Weights: Mutate the number slightly
        let numMatch = original.match(/-?[\d,.]+/);
        if(numMatch) {
            let val = parseFloat(numMatch[0].replace(',','.'));
            let diff = Math.floor(Math.random() * (val * 0.5)) + 1;
            let newVal = (Math.random() > 0.5) ? val + diff : val - diff;
            return original.replace(numMatch[0], Math.floor(newVal).toLocaleString());
        }
        return "???";
    }

    function handleKeyEntry(e) {
        if (e.key === 'Enter') checkKeyAnswer();
    }

    function checkKeyAnswer() {
        let val = document.getElementById('answer-input').value.trim();
        // Check against Meaning (English) OR Polish text
        let isCorrect = (val === currentEnglish || val.toLowerCase() === currentPolish.toLowerCase());
        
        if (isCorrect) handleSuccess(null);
        else {
            document.getElementById('answer-input').classList.add('wrong');
            gameState.streak = 0;
            updateGameUI();
        }
    }

    function checkAnswer(isCorrect, btn) {
        if (gameState.answered) return;
        if (isCorrect) handleSuccess(btn);
        else {
            btn.classList.add('wrong');
            gameState.streak = 0;
            updateGameUI();
        }
    }

    function handleSuccess(btn) {
        gameState.answered = true;
        if(btn) btn.classList.add('correct');
        else document.getElementById('answer-input').classList.add('correct');

        if (!gameState.peaked) {
            gameState.streak++;
            gameState.xp += (inputMode === 'key' ? 30 : 15);
        }
        reveal('polishText');
        reveal('englishText');
        updateGameUI();
    }

    function reveal(id) {
        document.getElementById(id).style.visibility = 'visible';
        if (id === 'englishText' && !gameState.answered) {
            gameState.peaked = true;
            gameState.streak = 0;
            updateGameUI();
        }
    }

    // --- UI/System Boilerplate ---
    function handleMinChange() {
        const minP = parseInt(document.getElementById('minPower').value);
        const maxS = document.getElementById('maxPower');
        if (parseInt(maxS.value) <= minP) maxS.value = minP + 1;
        updateSliders();
    }
    function updateSliders() {
        document.getElementById('minValLabel').innerText = Math.pow(10, document.getElementById('minPower').value).toLocaleString();
        document.getElementById('maxValLabel').innerText = Math.pow(10, document.getElementById('maxPower').value).toLocaleString();
    }
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById('nav-' + mode).classList.add('active');
        document.getElementById('sliderContainer').style.display = (mode === 'dates' || mode === 'time') ? 'none' : 'flex';
        document.getElementById('dateControls').style.display = (mode === 'dates') ? 'block' : 'none';
        document.getElementById('timeControls').style.display = (mode === 'time') ? 'block' : 'none';
        document.getElementById('priceControls').style.display = (mode === 'prices') ? 'block' : 'none';
        document.getElementById('weightControls').style.display = (mode === 'weights') ? 'block' : 'none';
        generateNext();
    }
    function toggleUILanguage() { uiLang = (uiLang === 'en' ? 'pl' : 'en'); updateUI(); }
    function updateUI() {
        const t = translations[uiLang];
        document.getElementById('lbl-title').innerText = t.title;
        document.getElementById('nav-numbers').innerText = t.numbers;
        document.getElementById('nav-prices').innerText = t.prices;
        document.getElementById('nav-dates').innerText = t.dates;
        document.getElementById('nav-time').innerText = t.time;
        document.getElementById('nav-weights').innerText = t.weights;
        document.getElementById('btn-listen').innerText = t.listen;
        document.getElementById('btn-next').innerText = t.next;
        document.getElementById('lbl-lvl').innerText = t.lvl;
        document.getElementById('lbl-streak').innerText = t.streak;
        document.getElementById('lbl-neg').innerText = t.neg;
    }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
    function showHelp() { document.getElementById('modalOverlay').style.display = 'flex'; }
    function closeHelp() { if (document.getElementById('dontShow').checked) localStorage.setItem('hidePolishHelp', 'true'); document.getElementById('modalOverlay').style.display = 'none'; }
    function speak(rate) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(currentPolish);
        u.lang = 'pl-PL'; u.rate = rate;
        window.speechSynthesis.speak(u);
    }

    window.onload = () => { 
        updateSliders(); updateUI(); setMode('numbers'); setInputMode('mc'); updateGameUI();
        if (!localStorage.getItem('hidePolishHelp')) showHelp();
    };
</script>
</body>
</html>
