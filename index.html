<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Polish Master Trainer</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/197/197529.png">

    <style>
        :root { --primary: #1a73e8; --secondary: #34a853; --accent: #673ab7; --bg: #f0f2f5; --card-bg: #ffffff; --text: #202124; --border: #e0e0e0; --xp-bar: #34a853; --error: #d93025; }
        .dark-mode { --bg: #000000; --card-bg: #1e1e1e; --text: #e8eaed; --border: #333; --xp-bar: #42f57e; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* Top Stats Bar - Ultra Compact */
        .stats-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card-bg); border-bottom: 1px solid var(--border);
            padding: 4px 12px; height: 40px; font-size: 0.8rem; font-weight: bold;
            flex-shrink: 0;
        }
        .xp-track { flex-grow: 1; height: 6px; background: #ddd; margin: 0 10px; border-radius: 3px; overflow: hidden; }
        .xp-fill { height: 100%; background: var(--xp-bar); width: 0%; transition: width 0.3s; }

        /* Navigation - Scrollable Horizontal */
        .nav-bar {
            display: flex; gap: 5px; overflow-x: auto; padding: 8px;
            background: var(--bg); flex-shrink: 0; scrollbar-width: none;
        }
        .nav-btn {
            background: var(--card-bg); border: 1px solid var(--border);
            padding: 6px 12px; border-radius: 15px; font-size: 0.75rem;
            white-space: nowrap; font-weight: 600; color: var(--text);
        }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Main Game Container */
        .game-container {
            flex-grow: 1; display: flex; flex-direction: column;
            padding: 10px; position: relative; overflow-y: auto;
        }

        /* Settings Drawer (Collapsible) */
        #config-drawer {
            display: none; background: var(--card-bg); padding: 10px;
            border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border);
        }
        #config-drawer.open { display: flex; flex-direction: column; gap: 8px; animation: slideDown 0.2s ease-out; }
        
        .config-toggle-btn {
            width: 100%; text-align: center; background: none; border: none;
            color: #888; font-size: 0.8rem; padding: 5px; cursor: pointer;
        }

        /* Controls inside Drawer */
        .control-row { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
        .control-box { background: rgba(0,0,0,0.03); padding: 5px 10px; border-radius: 8px; flex: 1; }
        input[type=range] { width: 100%; }
        
        /* Game Areas */
        .display-area {
            text-align: center; margin: auto 0; padding: 10px 0;
        }
        .polish-text { font-size: 1.2rem; color: var(--primary); font-weight: bold; visibility: hidden; min-height: 1.5em; margin-bottom: 5px;}
        .english-text { font-size: 0.9rem; color: #888; visibility: hidden; min-height: 1.2em; }

        .input-area { width: 100%; margin-bottom: 10px; }
        .mc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; height: 140px; }
        .mc-btn {
            background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px;
            font-size: 1.1rem; font-weight: bold; color: var(--text);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .mc-btn:active { background: #eee; transform: scale(0.98); }
        .mc-btn.correct { background: var(--secondary); color: white; border-color: var(--secondary); }
        .mc-btn.wrong { background: var(--error); color: white; opacity: 0.5; }

        .key-input {
            width: 100%; padding: 15px; font-size: 1.2rem; text-align: center;
            border-radius: 12px; border: 2px solid var(--border); background: var(--card-bg); color: var(--text);
        }

        /* Footer Controls */
        .footer-controls {
            flex-shrink: 0; background: var(--card-bg); padding: 10px;
            border-top: 1px solid var(--border); display: grid; gap: 8px;
            grid-template-columns: 1fr 1fr 1fr 1fr;
        }
        .action-btn {
            padding: 12px 0; border: none; border-radius: 8px; color: white; font-weight: bold; font-size: 0.9rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn-next { grid-column: span 4; background: #455a64; font-size: 1rem; }
        .btn-listen { grid-column: span 2; background: var(--secondary); }
        .btn-slow { background: #fb8c00; font-size: 0.8rem; }
        .btn-reveal { background: var(--primary); font-size: 0.8rem; }

        @keyframes slideDown { from {opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }
        
        /* Modal */
        #modalOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:1000; }
        .modal-content { background: var(--card-bg); padding: 20px; border-radius: 15px; width: 90%; max-width: 350px; }
    </style>
</head>
<body>

<div class="stats-bar">
    <span>LVL <span id="game-level" style="color:var(--primary)">1</span></span>
    <div class="xp-track"><div id="game-xp-bar" class="xp-fill"></div></div>
    <span>üî• <span id="game-streak">0</span></span>
    <button onclick="toggleConfig()" style="background:none; border:none; font-size:1.2rem; margin-left:10px;">‚öôÔ∏è</button>
</div>

<div class="nav-bar">
    <button id="nav-numbers" class="nav-btn active" onclick="setMode('numbers')">123</button>
    <button id="nav-prices" class="nav-btn" onclick="setMode('prices')">$$$</button>
    <button id="nav-dates" class="nav-btn" onclick="setMode('dates')">üìÖ</button>
    <button id="nav-time" class="nav-btn" onclick="setMode('time')">üïí</button>
    <button id="nav-weights" class="nav-btn" onclick="setMode('weights')">‚öñÔ∏è</button>
</div>

<div class="game-container">
    
    <div id="config-drawer">
        <div class="control-row">
            <button class="nav-btn" id="mode-mc" onclick="setInputMode('mc')">Choices</button>
            <button class="nav-btn" id="mode-key" onclick="setInputMode('key')">Typing</button>
            <button class="nav-btn" onclick="toggleDarkMode()">üåó Dark</button>
        </div>
        
        <div id="sliderContainer" style="display:block;">
            <div class="control-row" style="margin-top:5px;">
                <div class="control-box">
                    <span style="font-size:0.7rem; font-weight:bold;">Min: <span id="minValLabel">1</span></span>
                    <input type="range" id="minPower" min="0" max="6" value="0" oninput="handleMinChange()">
                </div>
                <div class="control-box">
                    <span style="font-size:0.7rem; font-weight:bold;">Max: <span id="maxValLabel">10</span></span>
                    <input type="range" id="maxPower" min="1" max="7" value="1" oninput="updateSliders()">
                </div>
            </div>
            <div class="control-row" style="margin-top:5px; justify-content:center;">
                <label style="font-size:0.8rem;"><input type="checkbox" id="allowNegatives" onchange="generateNext()"> Negative Numbers (-5)</label>
            </div>
        </div>

        <div id="priceControls" style="display:none; text-align:center;">
            <label style="font-size:0.8rem;"><input type="checkbox" id="includeGroszy" checked onchange="generateNext()"> Grosze</label>
        </div>
        <div id="timeControls" style="display:none; text-align:center;">
            <label style="font-size:0.8rem; margin-right:10px;"><input type="radio" name="timeStyle" id="styleFormal" onchange="generateNext()"> Formal</label>
            <label style="font-size:0.8rem;"><input type="radio" name="timeStyle" id="styleCasual" checked onchange="generateNext()"> Casual</label>
        </div>
        <div id="dateControls" style="display:none; text-align:center;">
            <label style="font-size:0.8rem;"><input type="checkbox" id="includeYear" checked onchange="generateNext()"> Year</label>
        </div>
    </div>

    <div class="display-area">
        <div id="polishText" class="polish-text">---</div>
        <div id="englishText" class="english-text">---</div>
    </div>

    <div class="input-area">
        <div id="mc-container" class="mc-grid"></div>
        <div id="key-container" style="display:none;">
            <input type="text" id="answer-input" class="key-input" placeholder="Type answer..." onkeydown="handleKeyEntry(event)">
        </div>
    </div>
</div>

<div class="footer-controls">
    <button class="action-btn btn-listen" onclick="speak(1.0)">üîä Repeat</button>
    <button class="action-btn btn-slow" onclick="speak(0.4)">üê¢ Slow</button>
    <button class="action-btn btn-reveal" onclick="forceReveal()">üëÅÔ∏è Show</button>
    <button class="action-btn btn-next" onclick="generateNext()">NEXT ‚û°Ô∏è</button>
</div>

<div id="modalOverlay">
    <div class="modal-content">
        <h3>How to Play</h3>
        <p>1. Tap <b>‚öôÔ∏è</b> to set range or switch between Buttons/Typing.</p>
        <p>2. Listen to the Polish audio.</p>
        <p>3. Guess the number!</p>
        <button class="action-btn btn-listen" onclick="closeHelp()" style="width:100%">Got it</button>
    </div>
</div>

<script>
    // --- Logic Section ---
    let currentMode = 'numbers', uiLang = 'en', currentPolish = "", currentEnglish = "";
    let inputMode = 'mc'; 
    let gameState = {
        xp: parseInt(localStorage.getItem('pl_xp_v4')) || 0,
        level: parseInt(localStorage.getItem('pl_lvl_v4')) || 1,
        streak: 0,
        answered: false
    };

    // Data
    const units = ["", "jeden", "dwa", "trzy", "cztery", "piƒôƒá", "sze≈õƒá", "siedem", "osiem", "dziewiƒôƒá"];
    const teens = ["dziesiƒôƒá", "jedena≈õcie", "dwana≈õcie", "trzyna≈õcie", "czterna≈õcie", "piƒôtna≈õcie", "szesna≈õcie", "siedemna≈õcie", "osiemna≈õcie", "dziewiƒôtna≈õcie"];
    const tens = ["", "", "dwadzie≈õcia", "trzydzie≈õci", "czterdzie≈õci", "piƒôƒádziesiƒÖt", "sze≈õƒádziesiƒÖt", "siedemdziesiƒÖt", "osiemdziesiƒÖt", "dziewiƒôƒádziesiƒÖt"];
    const hundreds = ["", "sto", "dwie≈õcie", "trzysta", "czterysta", "piƒôƒáset", "sze≈õƒáset", "siedemset", "osiemset", "dziewiƒôtset"];
    const ordinals = ["", "pierwszy", "drugi", "trzeci", "czwarty", "piƒÖty", "sz√≥sty", "si√≥dmy", "√≥smy", "dziewiƒÖty", "dziesiƒÖty", "jedenasty", "dwunasty", "trzynasty", "czternasty", "piƒôtnasty", "szesnasty", "siedemnasty", "osiemnasty", "dziewiƒôtnasty", "dwudziesty", "dwudziesty pierwszy", "dwudziesty drugi", "dwudziesty trzeci", "dwudziesty czwarty", "dwudziesty piƒÖty", "dwudziesty sz√≥sty", "dwudziesty si√≥dmy", "dwudziesty √≥smy", "dwudziesty dziewiƒÖty", "trzydziesty", "trzydziesty pierwszy"];
    const monthsGenitive = ["stycznia", "lutego", "marca", "kwietnia", "maja", "czerwca", "lipca", "sierpnia", "wrze≈õnia", "pa≈∫dziernika", "listopada", "grudnia"];
    const monthsEn = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const weekDaysPl = ["Poniedzia≈Çek", "Wtorek", "≈öroda", "Czwartek", "PiƒÖtek", "Sobota", "Niedziela"];
    const weekDaysEn = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

    function getPluralForm(n, singular, pluralA, pluralB) {
        n = Math.abs(n);
        if (n === 1) return singular;
        const lastDigit = n % 10, lastTwo = n % 100;
        if (lastDigit >= 2 && lastDigit <= 4 && (lastTwo < 10 || lastTwo > 20)) return pluralA;
        return pluralB;
    }

    function numberToPolish(n) {
        if (n === 0) return "zero";
        if (n < 0) return "minus " + numberToPolish(Math.abs(n));
        let res = "";
        let mil = Math.floor(n / 1000000);
        if (mil > 0) res += (mil === 1 ? "" : numberToPolish(mil) + " ") + getPluralForm(mil, "milion", "miliony", "milion√≥w") + " ";
        let thou = Math.floor((n % 1000000) / 1000);
        if (thou > 0) res += (thou === 1 ? "tysiƒÖc" : numberToPolish(thou) + " " + getPluralForm(thou, "tysiƒÖc", "tysiƒÖce", "tysiƒôcy")) + " ";
        let rem = n % 1000, h = Math.floor(rem / 100), t = Math.floor((rem % 100) / 10), u = rem % 10;
        if (h > 0) res += hundreds[h] + " ";
        if (t === 1) res += teens[u];
        else { if (t > 1) res += tens[t] + " "; if (u > 0) res += units[u]; }
        return res.trim();
    }

    function timeToPolish(hh, mm, formal) {
        const hoursOrdFem = ["p√≥≈Çnoc", "pierwsza", "druga", "trzecia", "czwarta", "piƒÖta", "sz√≥sta", "si√≥dma", "√≥sma", "dziewiƒÖta", "dziesiƒÖta", "jedenasta", "dwunasta", "trzynasta", "czternasta", "piƒôtnasta", "szesnasta", "siedemnasta", "osiemnasta", "dziewiƒôtnasta", "dwudziesta", "dwudziesta pierwsza", "dwudziesta druga", "dwudziesta trzecia"];
        const hoursOrdGen = ["p√≥≈Çnocy", "pierwszej", "drugiej", "trzeciej", "czwartej", "piƒÖtej", "sz√≥stej", "si√≥dmej", "√≥smej", "dziewiƒÖtej", "dziesiƒÖtej", "jedenastej", "dwunastej", "pierwszej"];
        if (formal) {
            let hStr = (hh === 0) ? "zero zero" : hoursOrdFem[hh];
            let mStr = (mm === 0) ? "" : (mm < 10 ? "zero " + units[mm] : numberToPolish(mm));
            return `${hStr} ${mStr}`.trim();
        } else {
            let displayH = hh % 12;
            const hNow = hoursOrdFem[displayH === 0 ? 12 : displayH];
            const hNext = hoursOrdGen[(displayH === 0 ? 0 : displayH) + 1];
            if (mm === 0) return hNow;
            if (mm === 30) return `wp√≥≈Ç do ${hNext}`;
            if (mm < 30) return `${numberToPolish(mm)} po ${hoursOrdGen[displayH === 0 ? 12 : displayH]}`;
            return `za ${numberToPolish(60 - mm)} ${hNext}`;
        }
    }

    // --- Game Engine ---
    function toggleConfig() {
        document.getElementById('config-drawer').classList.toggle('open');
        document.getElementById('config-drawer').style.display = 
            document.getElementById('config-drawer').style.display === 'flex' ? 'none' : 'flex';
    }

    function setInputMode(mode) {
        inputMode = mode;
        document.getElementById('mode-mc').style.background = mode==='mc' ? 'var(--primary)' : 'var(--card-bg)';
        document.getElementById('mode-mc').style.color = mode==='mc' ? '#fff' : 'var(--text)';
        document.getElementById('mode-key').style.background = mode==='key' ? 'var(--primary)' : 'var(--card-bg)';
        document.getElementById('mode-key').style.color = mode==='key' ? '#fff' : 'var(--text)';
        
        document.getElementById('mc-container').style.display = mode === 'mc' ? 'grid' : 'none';
        document.getElementById('key-container').style.display = mode === 'key' ? 'block' : 'none';
        if(!gameState.answered) setupMC(); // Refresh MC if mid-game
    }

    function updateGameUI() {
        const xpToLevel = gameState.level * 100;
        if (gameState.xp >= xpToLevel) { gameState.xp -= xpToLevel; gameState.level++; }
        localStorage.setItem('pl_xp_v4', gameState.xp);
        localStorage.setItem('pl_lvl_v4', gameState.level);
        
        document.getElementById('game-xp-bar').style.width = ((gameState.xp / xpToLevel) * 100) + '%';
        document.getElementById('game-level').innerText = gameState.level;
        document.getElementById('game-streak').innerText = gameState.streak;
    }

    function generateNext() {
        gameState.answered = false;
        document.getElementById('answer-input').value = "";
        document.getElementById('answer-input').style.borderColor = "var(--border)";
        
        // Hide config on new game to focus
        document.getElementById('config-drawer').style.display = 'none';

        const min = Math.pow(10, document.getElementById('minPower').value);
        const max = Math.pow(10, document.getElementById('maxPower').value);
        
        if (currentMode === 'dates') {
            const d = Math.floor(Math.random() * 31) + 1, m = Math.floor(Math.random() * 12);
            let enStr = `${d} ${monthsEn[m]}`, plStr = `${ordinals[d]} ${monthsGenitive[m]}`;
            if (document.getElementById('includeYear').checked) { 
                const y = Math.floor(Math.random() * 125) + 1900; 
                enStr += " " + y; plStr += " " + numberToPolish(y) + " roku"; 
            }
            currentEnglish = enStr; currentPolish = plStr;
        } else if (currentMode === 'time') {
            const hh = Math.floor(Math.random() * 24), mm = [0, 5, 10, 20, 25, 30, 35, 40, 50, 55][Math.floor(Math.random() * 10)];
            currentEnglish = `${hh.toString().padStart(2, '0')}:${mm.toString().padStart(2, '0')}`;
            currentPolish = timeToPolish(hh, mm, document.getElementById('styleFormal').checked);
        } else if (currentMode === 'weights') {
            // Simplified weight logic for compact mode
            let num = Math.floor(Math.random() * (max - min + 1)) + min;
            currentEnglish = `${num} kg`; currentPolish = `${numberToPolish(num)} kilogram√≥w`;
        } else {
            let num = Math.floor(Math.random() * (max - min + 1)) + min;
            if (currentMode === 'numbers' && document.getElementById('allowNegatives').checked && Math.random() > 0.5) num *= -1;
            
            if (currentMode === 'prices') {
                currentEnglish = num.toLocaleString() + " z≈Ç"; 
                currentPolish = numberToPolish(num) + " " + getPluralForm(num, "z≈Çoty", "z≈Çote", "z≈Çotych");
            } else {
                currentEnglish = num.toLocaleString(); 
                currentPolish = numberToPolish(num); 
            }
        }

        document.getElementById('polishText').style.visibility = 'hidden';
        document.getElementById('englishText').style.visibility = 'hidden';
        document.getElementById('polishText').innerText = currentPolish;
        document.getElementById('englishText').innerText = currentEnglish;

        if (inputMode === 'mc') setupMC();
        setTimeout(() => speak(1.0), 100);
    }

    function setupMC() {
        const container = document.getElementById('mc-container');
        container.innerHTML = "";
        let options = [{val: currentEnglish, correct: true}];
        while(options.length < 4) {
            let d = generateDecoy(currentEnglish);
            if (!options.some(o => o.val === d)) options.push({val: d, correct: false});
        }
        options.sort(() => Math.random() - 0.5);
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = "mc-btn";
            btn.innerText = opt.val;
            btn.onclick = () => checkAnswer(opt.correct, btn);
            container.appendChild(btn);
        });
    }

    function generateDecoy(orig) {
        if(currentMode==='time') return `${Math.floor(Math.random()*24).toString().padStart(2,'0')}:${Math.floor(Math.random()*60).toString().padStart(2,'0')}`;
        let match = orig.match(/-?[\d,.]+/);
        if(!match) return "???";
        let val = parseFloat(match[0].replace(',','.'));
        let diff = Math.floor(Math.random() * (val * 0.5)) + 1;
        let newVal = (Math.random() > 0.5) ? val + diff : val - diff;
        return orig.replace(match[0], Math.floor(newVal).toLocaleString());
    }

    function checkAnswer(isCorrect, btn) {
        if (gameState.answered) return;
        if (isCorrect) {
            if(btn) btn.classList.add('correct');
            else document.getElementById('answer-input').style.borderColor = "var(--secondary)";
            gameState.answered = true;
            gameState.streak++;
            gameState.xp += (inputMode === 'key' ? 30 : 15);
            revealAll();
        } else {
            if(btn) btn.classList.add('wrong');
            else document.getElementById('answer-input').style.borderColor = "var(--error)";
            gameState.streak = 0;
        }
        updateGameUI();
    }
    
    function handleKeyEntry(e) { if(e.key === 'Enter') {
        const val = document.getElementById('answer-input').value.trim();
        if(val === currentEnglish || val.toLowerCase() === currentPolish.toLowerCase()) checkAnswer(true, null);
        else checkAnswer(false, null);
    }}

    function forceReveal() {
        revealAll();
        gameState.streak = 0; // Penalty for manual reveal
        updateGameUI();
    }
    function revealAll() {
        document.getElementById('polishText').style.visibility = 'visible';
        document.getElementById('englishText').style.visibility = 'visible';
    }

    // --- Init ---
    function handleMinChange() {
        const minP = parseInt(document.getElementById('minPower').value);
        if (parseInt(document.getElementById('maxPower').value) <= minP) document.getElementById('maxPower').value = minP + 1;
        updateSliders();
    }
    function updateSliders() {
        document.getElementById('minValLabel').innerText = Math.pow(10, document.getElementById('minPower').value).toLocaleString();
        document.getElementById('maxValLabel').innerText = Math.pow(10, document.getElementById('maxPower').value).toLocaleString();
    }
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('nav-'+mode).classList.add('active');
        document.getElementById('sliderContainer').style.display = (mode=='dates'||mode=='time') ? 'none' : 'block';
        ['price','date','time'].forEach(k => document.getElementById(k+'Controls').style.display='none');
        if(mode=='prices') document.getElementById('priceControls').style.display='block';
        if(mode=='dates') document.getElementById('dateControls').style.display='block';
        if(mode=='time') document.getElementById('timeControls').style.display='block';
        generateNext();
    }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
    function speak(rate) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(currentPolish); u.lang='pl-PL'; u.rate=rate; window.speechSynthesis.speak(u); }
    function closeHelp() { document.getElementById('modalOverlay').style.display='none'; localStorage.setItem('hideHelpv2','true'); }

    window.onload = () => { 
        updateSliders(); setMode('numbers'); setInputMode('mc'); updateGameUI();
        if (!localStorage.getItem('hideHelpv2')) document.getElementById('modalOverlay').style.display='flex';
    };
</script>
</body>
</html>
