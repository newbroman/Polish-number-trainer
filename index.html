<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Polish Master Trainer</title>
    <meta name="theme-color" content="#1a73e8">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/197/197529.png">

    <style>
        /* Theme Variables */
        :root { --primary: #1a73e8; --secondary: #34a853; --bg: #f0f2f5; --card: #ffffff; --text: #202124; --border: #e0e0e0; --error: #d93025; --rank-color: #fbbc04; }
        @media (prefers-color-scheme: dark) {
            :root { --primary: #8ab4f8; --secondary: #81c995; --bg: #121212; --card: #1e1e1e; --text: #e8eaed; --border: #3c4043; --error: #f28b82; --rank-color: #fdd663; }
        }
        body.force-dark { --primary: #8ab4f8; --secondary: #81c995; --bg: #121212; --card: #1e1e1e; --text: #e8eaed; --border: #3c4043; --error: #f28b82; --rank-color: #fdd663; }
        body.force-light { --primary: #1a73e8; --secondary: #34a853; --bg: #f0f2f5; --card: #ffffff; --text: #202124; --border: #e0e0e0; --error: #d93025; --rank-color: #fbbc04; }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Polish Flag Header */
        .flag-header {
            width: 100%;
            height: 60px;
            display: flex;
            flex-direction: column;
            border-bottom: 2px solid rgba(0,0,0,0.1);
            position: relative;
        }
        .flag-top { background: #ffffff; flex: 1; }
        .flag-bottom { background: #dc143c; flex: 1; }
        .flag-title {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 900;
            font-size: 1.4rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #202124; /* Dark text for contrast on white/red */
            text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
            pointer-events: none;
        }

        /* Stats Bar */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 5px 15px; background: var(--card); border-bottom: 1px solid var(--border); height: 45px; flex-shrink: 0; }
        .stats { font-weight: 800; font-size: 0.85rem; display: flex; gap: 12px; align-items: center; }
        .rank-badge { color: var(--rank-color); text-transform: uppercase; font-size: 0.7rem; }
        .header-icons button { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 0 5px; color: var(--text); }

        /* Nav */
        .nav-scroller { display: flex; gap: 8px; overflow-x: auto; padding: 10px; background: var(--bg); flex-shrink: 0; scrollbar-width: none; border-bottom: 1px solid var(--border); }
        .nav-btn { background: var(--card); border: 1px solid var(--border); padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; color: var(--text); white-space: nowrap; cursor: pointer; }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Game Area */
        .game-area { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; padding-bottom: 120px; max-width: 600px; margin: 0 auto; width: 100%; }
        
        .display-box { text-align: center; margin-bottom: 15px; min-height: 90px; display: flex; flex-direction: column; justify-content: center; background: var(--card); border-radius: 16px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid var(--border); position: relative;}
        .pl-text { font-size: 1.4rem; color: var(--primary); font-weight: 700; margin-bottom: 5px; visibility: hidden; }
        .en-text { font-size: 1.1rem; color: #888; visibility: hidden; min-height: 1.2rem; }
        .visible { visibility: visible !important; animation: popIn 0.3s; }
        .blind-active { opacity: 0; } 
        
        .badge { position: absolute; top: 10px; right: 10px; font-size: 0.65rem; padding: 2px 8px; border-radius: 6px; font-weight: bold; display: none; }
        .badge-review { background: #e37400; color: white; }
        .badge-score { background: var(--secondary); color: white; animation: floatUp 1s forwards; display: none; }
        .badge-blind { left: 10px; right: auto; background: #607d8b; color: white; } 

        /* Grids */
        .mc-grid { display: grid; gap: 10px; flex-grow: 1; align-content: start; }
        .cols-2 { grid-template-columns: 1fr 1fr; }
        .cols-3 { grid-template-columns: 1fr 1fr 1fr; }
        
        /* Answer Button with Dynamic Font Support */
        .mc-btn { 
            position:relative; 
            background: var(--card); 
            border: 2px solid var(--border); 
            border-radius: 12px; 
            min-height: 65px; 
            font-weight: 700; 
            color: var(--text); 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            overflow: hidden;
            word-break: break-all;
            line-height: 1.1;
            text-align: center;
        }
        .mc-btn span.content { width: 100%; display: block; }
        .mc-btn:active { transform: scale(0.96); }
        .mc-key-hint { position: absolute; top: 2px; left: 5px; font-size: 0.65rem; color: var(--primary); opacity: 0.4; }
        
        .correct { background: var(--secondary) !important; color: white !important; border-color: var(--secondary) !important; }
        .wrong { background: var(--error) !important; color: white !important; opacity: 0.5; }

        .type-container { display: none; flex-direction: column; gap: 12px; }
        .type-input { width: 100%; padding: 15px; font-size: 1.4rem; text-align: center; border: 2px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text); outline: none; }
        .btn-check { width: 100%; background: var(--primary); color: white; padding: 15px; border-radius: 12px; font-weight: bold; border: none; font-size: 1rem; cursor: pointer; }

        /* Footer */
        .footer { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card); padding: 12px; border-top: 1px solid var(--border); display: grid; gap: 10px; z-index: 100; height: 90px; grid-template-columns: 1fr 1fr 1fr 2fr; box-shadow: 0 -4px 20px rgba(0,0,0,0.08); }
        .btn-action { border: none; border-radius: 10px; font-weight: 700; font-size: 0.9rem; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: transform 0.1s; }
        .btn-action:active { transform: scale(0.95); }
        .btn-listen { background: var(--secondary); font-size: 1.5rem; }
        .btn-slow { background: #fb8c00; font-size: 0.8rem; }
        .btn-vslow { background: #e65100; font-size: 0.8rem; }
        .btn-next { background: #455a64; font-size: 1rem; text-transform: uppercase; }
        .btn-next.ready { background: var(--primary); }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-box { background: var(--card); width: 92%; max-width: 400px; padding: 25px; border-radius: 20px; max-height: 85vh; overflow-y: auto; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .close-x { position: absolute; top: 15px; right: 20px; font-size: 1.8rem; background: none; border: none; cursor: pointer; color: var(--text); line-height: 1; }
        
        .set-group { background: rgba(0,0,0,0.04); padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .set-title { font-weight: 800; color: var(--primary); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 10px; }
        .set-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 0.9rem; font-weight: 600; }
        
        input[type=range] { width: 100%; }

        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes floatUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body onload="init()">

<div class="flag-header">
    <div class="flag-top"></div>
    <div class="flag-bottom"></div>
    <div class="flag-title">Trener Polskich Liczb</div>
</div>

<div class="header">
    <div class="stats">
        <div>‚≠ê <span id="xp-display">0</span> XP</div>
        <div id="rank-display" class="rank-badge">Novice</div>
        <div>üî• <span id="streak-display">0</span></div>
    </div>
    <div class="header-icons">
        <button onclick="toggleTranslator()">üó£Ô∏è</button>
        <button onclick="toggleHelp()">‚ùì</button>
        <button onclick="toggleSettings()">‚öôÔ∏è</button>
    </div>
</div>

<div class="nav-scroller">
    <button class="nav-btn active" onclick="setMode('numbers')" id="nav-numbers">123</button>
    <button class="nav-btn" onclick="setMode('fractions')" id="nav-fractions">¬Ω</button>
    <button class="nav-btn" onclick="setMode('prices')" id="nav-prices">$$$</button>
    <button class="nav-btn" onclick="setMode('dates')" id="nav-dates">üìÖ</button>
    <button class="nav-btn" onclick="setMode('time')" id="nav-time">üïí</button>
    <button class="nav-btn" onclick="setMode('weights')" id="nav-weights">‚öñÔ∏è</button>
</div>

<div class="game-area">
    <div class="display-box">
        <div id="badge-blind" class="badge badge-blind">üôà Blind Mode</div>
        <div id="badge-review" class="badge badge-review">Reviewing Mistake</div>
        <div id="badge-score" class="badge badge-score">+10 XP</div>
        <div id="pl-text" class="pl-text">---</div>
        <div id="en-text" class="en-text">---</div>
    </div>

    <div id="mc-area" class="mc-grid cols-2"></div>
    
    <div id="type-area" class="type-container">
        <input type="text" id="type-input" class="type-input" placeholder="Type answer..." autocomplete="off">
        <button class="btn-check" onclick="checkTyped()">CHECK ANSWER</button>
    </div>
</div>

<div class="footer">
    <button class="btn-action btn-listen" onclick="speak(1.0)">üîä</button>
    <button class="btn-action btn-slow" onclick="speak(0.6)">üê¢</button>
    <button class="btn-action btn-vslow" onclick="speak(0.3)">üêå</button>
    <button class="btn-action btn-next" id="main-btn" onclick="generate()">SKIP ‚û°Ô∏è</button>
</div>

<div id="settings-modal" class="modal">
    <div class="modal-box">
        <button class="close-x" onclick="toggleSettings()">√ó</button>
        <h2 style="margin-top:0">Settings</h2>
        <div class="set-group">
            <div class="set-title">Gameplay</div>
            <div class="set-row"><span>Blind Mode (Audio Only)</span><input type="checkbox" id="blind-toggle"></div>
             <div class="set-row"><span>Theme</span><select id="theme-select" onchange="applyTheme()"><option value="auto">Auto</option><option value="light">Light</option><option value="dark">Dark</option></select></div>
        </div>
        <div class="set-group">
            <div class="set-title">Difficulty Options</div>
            <div class="set-row"><span>Choice Count</span><select id="input-style" onchange="applySettings()"><option value="4">4 Buttons (-5 XP)</option><option value="8" selected>8 Buttons (-2 XP)</option><option value="12">12 Buttons (Full XP)</option><option value="type">Typing Mode</option></select></div>
        </div>
        <div class="set-group" id="set-range">
            <div class="set-title">Number Options</div>
            <div class="set-row"><span>Min: <span id="lbl-min">1</span></span><div style="width:50%"><input type="range" id="minP" min="0" max="6" value="0" oninput="updateRange()"></div></div>
            <div class="set-row"><span>Max: <span id="lbl-max">10</span></span><div style="width:50%"><input type="range" id="maxP" min="1" max="7" value="2" oninput="updateRange()"></div></div>
            <div class="set-row"><span>Negatives</span><input type="checkbox" id="neg-toggle"></div>
            <div class="set-row"><span>Include Decimals</span><input type="checkbox" id="decimal-toggle" onchange="document.getElementById('decimal-opts').style.display=this.checked?'flex':'none'"></div>
            <div class="set-row" id="decimal-opts" style="display:none"><span>Places</span><input type="range" id="decimal-places" min="1" max="4" value="2" oninput="document.getElementById('lbl-dp').innerText=this.value"><span id="lbl-dp" style="font-weight:bold;margin-left:10px">2</span></div>
        </div>
        <div class="set-group" id="set-prices" style="display:none"><div class="set-title">Price Options</div><div class="set-row"><span>Include Grosze</span><input type="checkbox" id="grosze-toggle" checked></div></div>
        <button class="btn-check" onclick="toggleSettings(); generate()">Save & Close</button>
    </div>
</div>

<script>
    // --- LINGUISTIC DATA ---
    const UNITS = ["", "jeden", "dwa", "trzy", "cztery", "piƒôƒá", "sze≈õƒá", "siedem", "osiem", "dziewiƒôƒá"];
    const TEENS = ["dziesiƒôƒá", "jedena≈õcie", "dwana≈õcie", "trzyna≈õcie", "czterna≈õcie", "piƒôtna≈õcie", "szesna≈õcie", "siedemna≈õcie", "osiemna≈õcie", "dziewiƒôtna≈õcie"];
    const TENS = ["", "", "dwadzie≈õcia", "trzydzie≈õci", "czterdzie≈õci", "piƒôƒádziesiƒÖt", "sze≈õƒádziesiƒÖt", "siedemdziesiƒÖt", "osiemdziesiƒÖt", "dziewiƒôƒádziesiƒÖt"];
    const HUNDREDS = ["", "sto", "dwie≈õcie", "trzysta", "czterysta", "piƒôƒáset", "sze≈õƒáset", "siedemset", "osiemset", "dziewiƒôtset"];
    const MONTHS_PL = ["stycznia", "lutego", "marca", "kwietnia", "maja", "czerwca", "lipca", "sierpnia", "wrze≈õnia", "pa≈∫dziernika", "listopada", "grudnia"];
    const MONTHS_EN = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const HOURS_ORD_FEM = ["p√≥≈Çnoc", "pierwsza", "druga", "trzecia", "czwarta", "piƒÖta", "sz√≥sta", "si√≥dma", "√≥sma", "dziewiƒÖta", "dziesiƒÖta", "jedenasta", "dwunasta", "trzynasta", "czternasta", "piƒôtnasta", "szesnasta", "siedemnasta", "osiemnasta", "dziewiƒôtnasta", "dwudziesta", "dwudziesta pierwsza", "dwudziesta druga", "dwudziesta trzecia"];
    const HOURS_ORD_GEN = ["p√≥≈Çnocy", "pierwszej", "drugiej", "trzeciej", "czwartej", "piƒÖtej", "sz√≥stej", "si√≥dmej", "√≥smej", "dziewiƒÖtej", "dziesiƒÖtej", "jedenastej", "dwunastej", "pierwszej"];
    const DENOM_S = [null, null, "druga", "trzecia", "czwarta", "piƒÖta", "sz√≥sta", "si√≥dma", "√≥sma", "dziewiƒÖta", "dziesiƒÖta", "jedenasta", "dwunasta", "trzynasta", "czternasta", "piƒôtnasta", "szesnasta"];
    const DENOM_P = [null, null, "drugie", "trzecie", "czwarte", "piƒÖte", "sz√≥ste", "si√≥dme", "√≥sme", "dziewiƒÖte", "dziesiƒÖte", "jedenaste", "dwunaste", "trzynaste", "czternaste", "piƒôtnaste", "szesnaste"];
    const DENOM_G = [null, null, "drugich", "trzecich", "czwartych", "piƒÖtych", "sz√≥stych", "si√≥dmych", "√≥smych", "dziewiƒÖtych", "dziesiƒÖtych", "jedenastych", "dwunastych", "trzynastych", "czternastych", "piƒôtnastych", "szesnastych"];

    const RANKS = [{n:"Novice",l:0},{n:"Apprentice",l:500},{n:"Intermediate",l:1500},{n:"Advanced",l:3000},{n:"Expert",l:5000},{n:"Master",l:10000},{n:"Grandmaster",l:20000}];

    let state = { mode: 'numbers', currentPL: '', currentEN: '', xp: 0, streak: 0, solved: false, btnCount: 8, rawData: null, isReview: false, startTime: 0, audioClicks: 0, wrongGuesses: 0, history: [] };
    let mistakes = JSON.parse(localStorage.getItem('mistakes') || "[]");
    let categoryStats = JSON.parse(localStorage.getItem('catStats') || '{"numbers":0,"fractions":0,"prices":0,"dates":0,"time":0,"weights":0}');
    let autoNextTimer = null;
    let audioCtx = null;

    function init() {
        state.xp = parseInt(localStorage.getItem('xp') || 0);
        document.addEventListener('keydown', (e) => {
            if (state.solved) return;
            if (!isNaN(parseInt(e.key))) { const idx = parseInt(e.key) - 1; const buttons = document.querySelectorAll('.mc-btn'); if (buttons[idx]) buttons[idx].click(); }
            if (e.key === 'Enter' && document.getElementById('input-style').value === 'type') checkTyped();
        });
        updateUI(); updateRange(); setMode('numbers');
        let u = new SpeechSynthesisUtterance(''); window.speechSynthesis.speak(u);
    }

    function getPlural(n, s, pa, pb) {
        n = Math.abs(n); if (n === 1) return s;
        let r10 = n % 10, r100 = n % 100;
        if (r10 >= 2 && r10 <= 4 && (r100 < 10 || r100 > 20)) return pa;
        return pb;
    }

    function numToPl(n) {
        if (n === 0) return "zero"; if (n < 0) return "minus " + numToPl(Math.abs(n));
        let s = "";
        if (n >= 1000000) { let m = Math.floor(n/1000000); s += (m===1?"":numToPl(m)+" ") + getPlural(m,"milion","miliony","milion√≥w") + " "; n %= 1000000; }
        if (n >= 1000) { let t = Math.floor(n/1000); s += (t===1?"tysiƒÖc":numToPl(t)+" "+getPlural(t,"tysiƒÖc","tysiƒÖce","tysiƒôcy")) + " "; n %= 1000; }
        if (n >= 100) { s += HUNDREDS[Math.floor(n/100)] + " "; n %= 100; }
        if (n >= 20) { s += TENS[Math.floor(n/10)] + " "; n %= 10; }
        if (n >= 10) { s += TEENS[n-10] + " "; n = 0; }
        if (n > 0) s += UNITS[n];
        return s.trim();
    }

    function getFractionPl(n, d) {
        if (n===1 && d===2) return "jedna druga (p√≥≈Ç)"; if (n===1 && d===4) return "jedna czwarta (ƒáwierƒá)"; if (n===3 && d===4) return "trzy czwarte";
        let numStr = (n === 1) ? "jedna" : (n === 2 ? "dwie" : numToPl(n));
        let denStr = (n === 1) ? DENOM_S[d] : (n%10 >= 2 && n%10 <= 4 && (n%100 < 10 || n%100 > 20)) ? DENOM_P[d] : DENOM_G[d];
        return `${numStr} ${denStr}`;
    }

    function timeToPl(h, m, formal) {
        if (formal) { let hStr = (h===0) ? "zero zero" : HOURS_ORD_FEM[h]; let mStr = (m===0) ? "" : (m<10 ? "zero "+UNITS[m] : numToPl(m)); return `${hStr} ${mStr}`.trim(); }
        else { let dispH = h % 12; let hNext = HOURS_ORD_GEN[(dispH===0?0:dispH) + 1]; if((dispH===0?0:dispH) + 1 >= HOURS_ORD_GEN.length) hNext = HOURS_ORD_GEN[1]; if (m === 0) return HOURS_ORD_FEM[(dispH===0?12:dispH)]; if (m === 30) return `wp√≥≈Ç do ${hNext}`; if (m < 30) return `${numToPl(m)} po ${HOURS_ORD_GEN[dispH===0?12:dispH]}`; return `za ${numToPl(60-m)} ${hNext}`; }
    }

    // Font auto-sizer
    function adjustFontSize(btn, text) {
        let size = 1.1; 
        if (text.length > 8) size = 0.95;
        if (text.length > 12) size = 0.8;
        if (text.length > 15) size = 0.65;
        btn.style.fontSize = size + "rem";
    }

    function generate() {
        if (autoNextTimer) clearTimeout(autoNextTimer);
        state.solved = false; state.audioClicks = 0; state.wrongGuesses = 0;
        document.getElementById('pl-text').classList.remove('visible');
        document.getElementById('en-text').classList.remove('visible');
        document.getElementById('en-text').classList.toggle('blind-active', document.getElementById('blind-toggle').checked);
        document.getElementById('badge-blind').style.display = document.getElementById('blind-toggle').checked ? 'block' : 'none';
        document.getElementById('badge-review').style.display = 'none'; document.getElementById('badge-score').style.display = 'none';
        document.getElementById('main-btn').innerText = "SKIP ‚û°Ô∏è"; document.getElementById('main-btn').classList.remove('ready');
        document.getElementById('type-input').value = "";

        const min = Math.pow(10, document.getElementById('minP').value);
        const max = Math.pow(10, document.getElementById('maxP').value);

        let useMistake = (state.mode === 'numbers' && mistakes.length > 0 && Math.random() < 0.3);
        if (useMistake) {
            let target = mistakes[Math.floor(Math.random() * mistakes.length)]; setupNumber(target);
            state.isReview = true; document.getElementById('badge-review').style.display = 'block';
        } else {
            let newVal; let safety = 0;
            do { newVal = generateRawValue(min, max); safety++; } while (isRepeated(newVal) && safety < 20);
            state.history.push(newVal); if(state.history.length > 5) state.history.shift();
            processValue(newVal);
        }
        document.getElementById('pl-text').innerText = state.currentPL;
        document.getElementById('en-text').innerText = state.currentEN;
        applySettings(); state.startTime = Date.now(); setTimeout(() => speak(1.0), 200);
    }

    function generateRawValue(min, max) {
        if (state.mode === 'numbers') {
            if (document.getElementById('decimal-toggle').checked) return parseFloat((Math.random() * (max - min) + min).toFixed(parseInt(document.getElementById('decimal-places').value)));
            else { let n = Math.floor(Math.random() * (max - min + 1)) + min; if (document.getElementById('neg-toggle').checked && Math.random() > 0.5) n *= -1; return n; }
        }
        if (state.mode === 'fractions') return {n: Math.floor(Math.random() * 14) + 1, d: Math.floor(Math.random() * 15) + 2};
        if (state.mode === 'prices') return Math.floor(Math.random() * (max-min+1)) + min + (Math.floor(Math.random()*99)/100);
        if (state.mode === 'time') return {h: Math.floor(Math.random()*24), m: Math.floor(Math.random()*12)*5};
        if (state.mode === 'dates') return {d: Math.floor(Math.random()*30)+1, m: Math.floor(Math.random()*12), y: document.getElementById('year-toggle').checked ? Math.floor(Math.random()*25)+2000 : 0};
        if (state.mode === 'weights') return Math.floor(Math.random() * (max-min+1)) + min;
    }

    function processValue(val) {
        state.rawData = val;
        if (state.mode === 'numbers') {
            if(document.getElementById('decimal-toggle').checked) { let s = val.toString(); state.currentEN = s.replace('.', ','); state.currentPL = `${numToPl(parseInt(s.split('.')[0]))} przecinek ${readDecimalPart(s.split('.')[1])}`; }
            else setupNumber(val);
        } else if (state.mode === 'fractions') { state.currentEN = `${val.n}/${val.d}`; state.currentPL = getFractionPl(val.n, val.d); }
        else if (state.mode === 'prices') { let n = Math.floor(val); let gr = Math.round((val%1)*100); state.currentEN = `${n},${gr.toString().padStart(2,'0')} z≈Ç`; state.currentPL = `${numToPl(n)} ${getPlural(n,'z≈Çoty','z≈Çote','z≈Çotych')}` + (gr>0?` i ${numToPl(gr)} ${getPlural(gr,'grosz','grosze','groszy')}`:""); }
        else if (state.mode === 'time') { let isCasual = document.querySelector('input[name="t-style"]:checked').value === 'casual'; state.currentEN = `${val.h.toString().padStart(2,'0')}:${val.m.toString().padStart(2,'0')}`; state.currentPL = timeToPl(val.h, val.m, !isCasual); }
        else if (state.mode === 'dates') { state.currentEN = `${val.d}/${val.m+1}${val.y? '/'+val.y : ''}`; state.currentPL = `dzie≈Ñ ${numToPl(val.d)} miesiƒÖca ${MONTHS_PL[val.m]}`; }
        else if (state.mode === 'weights') { state.currentEN = val + " kg"; state.currentPL = numToPl(val) + " kilogram√≥w"; }
    }

    function isRepeated(val) { for(let item of state.history) { if(JSON.stringify(item) === JSON.stringify(val)) return true; } return false; }
    function setupNumber(n) { state.currentEN = n.toLocaleString(); state.currentPL = numToPl(n); state.rawData = n; }
    function readDecimalPart(str) { if (!str) return ""; return str.split('').map(d => numToPl(parseInt(d))).join(' '); }

    function applySettings() {
        let style = document.getElementById('input-style').value;
        if (style === 'type') { document.getElementById('mc-area').style.display = 'none'; document.getElementById('type-area').style.display = 'flex'; }
        else { state.btnCount = parseInt(style); document.getElementById('mc-area').style.display = 'grid'; document.getElementById('type-area').style.display = 'none'; document.getElementById('mc-area').className = 'mc-grid ' + (state.btnCount === 12 ? 'cols-3' : 'cols-2'); generateGrid(); }
    }

    function generateGrid() {
        const container = document.getElementById('mc-area'); container.innerHTML = '';
        let opts = [state.currentEN];
        const min = Math.pow(10, document.getElementById('minP').value);
        const max = Math.pow(10, document.getElementById('maxP').value);
        while(opts.length < state.btnCount) { let decoy = makeDecoy(state.currentEN, min, max); if(!opts.includes(decoy)) opts.push(decoy); }
        opts.sort(() => Math.random() - 0.5);
        opts.forEach((val, index) => {
            let b = document.createElement('button'); b.className = 'mc-btn';
            let hint = document.createElement('span'); hint.className = 'mc-key-hint'; hint.innerText = index + 1;
            b.appendChild(hint); b.appendChild(document.createTextNode(val));
            adjustFontSize(b, val);
            b.onclick = () => check(val, b);
            container.appendChild(b);
        });
    }

    function makeDecoy(target, min, max) {
        if (state.mode === 'fractions') return (Math.floor(Math.random()*10)+1) + "/" + (Math.floor(Math.random()*10)+2);
        if (state.mode === 'time') return Math.floor(Math.random()*24).toString().padStart(2,'0') + ":" + Math.floor(Math.random()*60).toString().padStart(2,'0');
        if (state.mode === 'numbers' && document.getElementById('decimal-toggle').checked) return (Math.random()*(max-min)+min).toFixed(parseInt(document.getElementById('decimal-places').value)).replace('.', ',');
        return Math.floor(Math.random() * (max-min+1) + min).toLocaleString();
    }

    function check(val, btn) { if (!state.solved) { if (val === state.currentEN) win(btn); else lose(btn); } }
    function win(btn) {
        playSound('correct'); state.solved = true;
        let score = 10; const style = document.getElementById('input-style').value;
        if (style === '8') score -= 2; if (style === '4') score -= 5;
        if (typeof state.rawData === 'number') { let v = Math.abs(state.rawData); if (v >= 10000) score += 10; else if (v >= 1000) score += 5; else if (v >= 100) score += 2; }
        if (document.getElementById('blind-toggle').checked) score += 5;
        score -= (state.audioClicks * 2 + state.wrongGuesses * 5); if (score < 1) score = 1;
        state.xp += score; state.streak++; categoryStats[state.mode] += score; saveAllStats();
        document.getElementById('badge-score').innerText = `+${score} XP`; document.getElementById('badge-score').style.display = 'block';
        if(btn) btn.classList.add('correct');
        document.getElementById('pl-text').classList.add('visible'); document.getElementById('en-text').classList.remove('blind-active'); document.getElementById('en-text').classList.add('visible');
        document.getElementById('main-btn').innerText = "NEXT >> (5s)"; document.getElementById('main-btn').classList.add('ready');
        autoNextTimer = setTimeout(generate, 5000); updateUI();
    }

    function lose(btn) {
        playSound('wrong'); state.streak = 0; state.wrongGuesses++;
        if(btn) btn.classList.add('wrong');
        if(document.getElementById('blind-toggle').checked) { document.getElementById('en-text').classList.remove('blind-active'); document.getElementById('en-text').classList.add('visible'); }
        updateUI();
    }

    function updateUI() {
        let rank = RANKS[0]; for(let r of RANKS) if(state.xp >= r.l) rank = r;
        document.getElementById('rank-display').innerText = rank.n;
        document.getElementById('xp-display').innerText = state.xp;
        document.getElementById('streak-display').innerText = state.streak;
        let min = document.getElementById('minP').value, max = document.getElementById('maxP').value;
        document.getElementById('lbl-min').innerText = Math.pow(10, min).toLocaleString();
        document.getElementById('lbl-max').innerText = Math.pow(10, max).toLocaleString();
    }

    function updateRange() { updateUI(); }
    function saveAllStats() { localStorage.setItem('xp', state.xp); localStorage.setItem('catStats', JSON.stringify(categoryStats)); }
    function setMode(m) { state.mode = m; document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.id === 'nav-'+m)); generate(); }
    function toggleSettings() { let d=document.getElementById('settings-modal'); d.style.display=(d.style.display==='flex')?'none':'flex'; }
    function speak(rate) { if (!state.solved && rate === 1.0) state.audioClicks++; window.speechSynthesis.cancel(); let u = new SpeechSynthesisUtterance(state.currentPL); u.lang = 'pl-PL'; u.rate = rate; window.speechSynthesis.speak(u); }
    function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function playSound(type) { initAudio(); const osc = audioCtx.createOscillator(), gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); if (type === 'correct') { osc.frequency.setValueAtTime(500, 0); gain.gain.setValueAtTime(0.1, 0); } else { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, 0); } osc.start(); osc.stop(audioCtx.currentTime + 0.2); }
    function toggleTranslator() { alert("Type & Speak is in the translation settings!"); }
    function toggleHelp() { alert("Goal: Listen to Polish numbers and answer quickly!"); }
    function applyTheme() { const t = document.getElementById('theme-select').value; document.body.className = t === 'dark' ? 'force-dark' : 'force-light'; }
</script>
</body>
</html>
